<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Cache Firebase</title>
    <script src="config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .container {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a6fd8;
        }
        #logs {
            background: #0f0f23;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üé§ Teste Cache Firebase - Karaoke</h1>
    
    <div class="container">
        <h2>Status da Conex√£o</h2>
        <p id="connectionStatus">Verificando conex√£o...</p>
        <p id="authStatus">Verificando autentica√ß√£o...</p>
    </div>

    <div class="container">
        <h2>Testes de Cache</h2>
        <button onclick="testGetCache()">Testar Buscar Cache</button>
        <button onclick="testSaveCache()">Testar Salvar Cache</button>
        <button onclick="clearLogs()">Limpar Logs</button>
    </div>

    <div class="container">
        <h2>Logs do Console</h2>
        <div id="logs"></div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // Configura√ß√£o do Firebase - usando configura√ß√µes centralizadas
        if (!window.firebaseConfig || !validateConfig(window.firebaseConfig)) {
            document.getElementById('connectionStatus').innerHTML = 
                '<span style="color: #f44336;">‚ùå Configura√ß√µes do Firebase n√£o encontradas ou inv√°lidas!</span>';
            return;
        }

        // Inicializar Firebase
        firebase.initializeApp(window.firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Elementos da p√°gina
        const connectionStatus = document.getElementById('connectionStatus');
        const authStatus = document.getElementById('authStatus');
        const logsDiv = document.getElementById('logs');

        // Fun√ß√£o para adicionar logs na tela
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        // Interceptar console.log para mostrar na tela
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '));
        };

        // Interceptar console.error para mostrar na tela
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '));
        };

        // Verificar conex√£o e autentica√ß√£o
        addLog('üî• Iniciando Firebase...');
        connectionStatus.textContent = 'Conectando ao Firebase...';
        authStatus.textContent = 'Fazendo login an√¥nimo...';

        // Autentica√ß√£o an√¥nima
        auth.signInAnonymously().then(() => {
            addLog('‚úÖ Autentica√ß√£o an√¥nima bem-sucedida');
            authStatus.textContent = '‚úÖ Usu√°rio autenticado anonimamente';
            connectionStatus.textContent = '‚úÖ Conectado ao Firebase';
        }).catch((error) => {
            addLog('‚ùå Erro na autentica√ß√£o: ' + error.message);
            authStatus.textContent = '‚ùå Erro na autentica√ß√£o: ' + error.message;
        });

        // Dados de teste
        const testSongs = [
            { title: 'Evid√™ncias', artist: 'Chit√£ozinho & Xoror√≥', genre: 'sertanejo' },
            { title: 'Ainda Bem', artist: 'Marisa Monte', genre: 'mpb' },
            { title: 'Eduardo e M√¥nica', artist: 'Legi√£o Urbana', genre: 'rock' }
        ];

        // Fun√ß√£o para testar buscar cache
        async function testGetCache() {
            addLog('üîç Testando busca no cache...');
            
            try {
                if (!auth.currentUser) {
                    await auth.signInAnonymously();
                }

                const cacheRef = db.collection('songsCache').doc('cached_songs');
                const doc = await cacheRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    addLog(`‚úÖ Cache encontrado! ${data.songs.length} m√∫sicas, vers√£o ${data.version}`);
                    addLog(`üìÖ Cache criado em: ${new Date(data.timestamp).toLocaleString()}`);
                } else {
                    addLog('‚ÑπÔ∏è Nenhum cache encontrado');
                }
            } catch (error) {
                addLog('‚ùå Erro ao buscar cache: ' + error.message);
            }
        }

        // Fun√ß√£o para testar salvar cache
        async function testSaveCache() {
            addLog('üíæ Testando salvamento no cache...');
            
            try {
                if (!auth.currentUser) {
                    await auth.signInAnonymously();
                }

                const cacheData = {
                    songs: testSongs,
                    timestamp: Date.now(),
                    version: '1.0',
                    totalSongs: testSongs.length
                };

                // Remover cache antigo
                const cacheRef = db.collection('songsCache').doc('cached_songs');
                await cacheRef.delete();
                addLog('üóëÔ∏è Cache antigo removido');

                // Salvar novo cache
                await cacheRef.set(cacheData);
                addLog(`‚úÖ Cache salvo com sucesso! ${testSongs.length} m√∫sicas`);
                
            } catch (error) {
                addLog('‚ùå Erro ao salvar cache: ' + error.message);
            }
        }

        // Fun√ß√£o para limpar logs
        function clearLogs() {
            logsDiv.textContent = '';
        }

        // Adicionar log inicial
        addLog('üé§ Teste de Cache Firebase iniciado');
    </script>
</body>
</html>