<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Firebase - Karaok√™</title>
    <script src="config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .danger {
            background: #dc3545;
            color: white;
        }
        .danger:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <h1>üîß Debug Firebase - Limpeza de Cole√ß√µes</h1>
    
    <div class="test-section">
        <h2>1. Status Atual das Cole√ß√µes</h2>
        <button class="test-button" onclick="listCollections()">Verificar Cole√ß√µes</button>
        <div id="collections-result"></div>
    </div>

    <div class="test-section">
        <h2>2. An√°lise Detalhada</h2>
        <button class="test-button" onclick="analyzeCollections()">Analisar Todas as Cole√ß√µes</button>
        <div id="analysis-result"></div>
    </div>

    <div class="test-section">
        <h2>3. üóëÔ∏è Remover Cole√ß√µes Desnecess√°rias</h2>
        <p><strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Esta opera√ß√£o ir√° remover permanentemente as cole√ß√µes que n√£o s√£o mais utilizadas pelo sistema.</p>
        <button class="test-button danger" onclick="removeUnusedCollections()">Remover Cole√ß√µes N√£o Utilizadas</button>
        <div id="cleanup-result"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        // Configura√ß√£o do Firebase - usando configura√ß√µes centralizadas
        if (!window.firebaseConfig || !validateConfig(window.firebaseConfig)) {
            alert('‚ùå Configura√ß√µes do Firebase n√£o encontradas ou inv√°lidas!');
            throw new Error('Configura√ß√µes do Firebase necess√°rias n√£o encontradas');
        }

        // Inicializar Firebase
        firebase.initializeApp(window.firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        async function ensureAuth() {
            if (!auth.currentUser) {
                await auth.signInAnonymously();
            }
        }

        async function listCollections() {
            try {
                showResult('collections-result', 'üîÑ Verificando cole√ß√µes...', 'info');
                await ensureAuth();
                
                // Cole√ß√µes conhecidas do sistema
                const collections = ['songs', 'songsCache', 'searchCache', 'debug_test'];
                let results = [];
                
                for (const collectionName of collections) {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        const status = collectionName === 'songs' ? '‚úÖ PRINCIPAL' : 
                                     collectionName === 'songsCache' ? '‚ö†Ô∏è CACHE' :
                                     collectionName === 'searchCache' ? '‚ö†Ô∏è CACHE' : 'üóëÔ∏è TESTE';
                        results.push(`${collectionName}: ${snapshot.size} documento(s) - ${status}`);
                    } catch (error) {
                        results.push(`${collectionName}: ‚ùå Erro - ${error.message}`);
                    }
                }
                
                showResult('collections-result', `üìã Status das Cole√ß√µes:\n${results.join('\n')}`, 'info');
            } catch (error) {
                showResult('collections-result', `‚ùå Erro ao verificar cole√ß√µes: ${error.message}`, 'error');
            }
        }

        async function analyzeCollections() {
            try {
                showResult('analysis-result', 'üîÑ Analisando cole√ß√µes...', 'info');
                await ensureAuth();
                
                let result = 'üìä AN√ÅLISE DETALHADA:\n\n';
                
                // Analisar cole√ß√£o 'songs' (PRINCIPAL)
                try {
                    const songsSnapshot = await db.collection('songs').get();
                    result += `1Ô∏è‚É£ COLE√á√ÉO 'songs' (PRINCIPAL):\n`;
                    result += `   - Documentos: ${songsSnapshot.size}\n`;
                    result += `   - Status: ‚úÖ MANTER - √â a cole√ß√£o principal do sistema\n\n`;
                } catch (error) {
                    result += `1Ô∏è‚É£ COLE√á√ÉO 'songs': ‚ùå Erro - ${error.message}\n\n`;
                }
                
                // Analisar cole√ß√£o 'songsCache' (CACHE - pode ter documentos antigos)
                try {
                    const cacheSnapshot = await db.collection('songsCache').get();
                    result += `2Ô∏è‚É£ COLE√á√ÉO 'songsCache' (CACHE):\n`;
                    result += `   - Documentos: ${cacheSnapshot.size}\n`;
                    
                    if (cacheSnapshot.size > 0) {
                        result += `   - Documentos encontrados:\n`;
                        cacheSnapshot.forEach(doc => {
                            const data = doc.data();
                            result += `     ‚Ä¢ ${doc.id}: `;
                            if (data.songs && Array.isArray(data.songs)) {
                                result += `${data.songs.length} m√∫sicas`;
                            } else {
                                result += `${Object.keys(data).length} campos`;
                            }
                            result += `\n`;
                        });
                        result += `   - Status: ‚ö†Ô∏è VERIFICAR - Pode conter dados antigos\n\n`;
                    } else {
                        result += `   - Status: ‚úÖ VAZIO - Nada para limpar\n\n`;
                    }
                } catch (error) {
                    result += `2Ô∏è‚É£ COLE√á√ÉO 'songsCache': ‚ùå Erro - ${error.message}\n\n`;
                }
                
                // Analisar cole√ß√£o 'searchCache' (CACHE DE BUSCA)
                try {
                    const searchSnapshot = await db.collection('searchCache').get();
                    result += `3Ô∏è‚É£ COLE√á√ÉO 'searchCache' (CACHE DE BUSCA):\n`;
                    result += `   - Documentos: ${searchSnapshot.size}\n`;
                    result += `   - Status: ${searchSnapshot.size > 0 ? 'üóëÔ∏è PODE REMOVER - Cache de busca antigo' : '‚úÖ VAZIO'}\n\n`;
                } catch (error) {
                    result += `3Ô∏è‚É£ COLE√á√ÉO 'searchCache': ‚ùå Erro - ${error.message}\n\n`;
                }
                
                // Analisar cole√ß√£o 'debug_test' (TESTE)
                try {
                    const debugSnapshot = await db.collection('debug_test').get();
                    result += `4Ô∏è‚É£ COLE√á√ÉO 'debug_test' (TESTE):\n`;
                    result += `   - Documentos: ${debugSnapshot.size}\n`;
                    result += `   - Status: ${debugSnapshot.size > 0 ? 'üóëÔ∏è PODE REMOVER - Dados de teste' : '‚úÖ VAZIO'}\n\n`;
                } catch (error) {
                    result += `4Ô∏è‚É£ COLE√á√ÉO 'debug_test': ‚ùå Erro - ${error.message}\n\n`;
                }
                
                result += `üí° RECOMENDA√á√ÉO:\n`;
                result += `   ‚úÖ MANTER: 'songs' (cole√ß√£o principal)\n`;
                result += `   üóëÔ∏è REMOVER: 'searchCache' (cache antigo)\n`;
                result += `   üóëÔ∏è REMOVER: 'debug_test' (dados de teste)\n`;
                result += `   üóëÔ∏è REMOVER: 'songsCache' (cache desnecess√°rio - temos a cole√ß√£o 'songs')\n`;
                
                showResult('analysis-result', result, 'info');
                
            } catch (error) {
                showResult('analysis-result', `‚ùå Erro na an√°lise: ${error.message}`, 'error');
            }
        }

        async function removeUnusedCollections() {
            try {
                showResult('cleanup-result', 'üóëÔ∏è Iniciando remo√ß√£o de cole√ß√µes desnecess√°rias...', 'info');
                await ensureAuth();
                
                let removedCount = 0;
                let result = '';
                
                // 1. Remover cole√ß√£o 'searchCache' (cache de busca antigo)
                try {
                    const searchSnapshot = await db.collection('searchCache').get();
                    if (!searchSnapshot.empty) {
                        const batch = db.batch();
                        searchSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        result += `‚úÖ Cole√ß√£o 'searchCache' removida (${searchSnapshot.size} documentos)\n`;
                        removedCount += searchSnapshot.size;
                    } else {
                        result += `‚ÑπÔ∏è Cole√ß√£o 'searchCache' j√° estava vazia\n`;
                    }
                } catch (error) {
                    result += `‚ö†Ô∏è Erro ao remover 'searchCache': ${error.message}\n`;
                }
                
                // 2. Remover cole√ß√£o 'debug_test' (dados de teste)
                try {
                    const debugSnapshot = await db.collection('debug_test').get();
                    if (!debugSnapshot.empty) {
                        const batch = db.batch();
                        debugSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        result += `‚úÖ Cole√ß√£o 'debug_test' removida (${debugSnapshot.size} documentos)\n`;
                        removedCount += debugSnapshot.size;
                    } else {
                        result += `‚ÑπÔ∏è Cole√ß√£o 'debug_test' j√° estava vazia\n`;
                    }
                } catch (error) {
                    result += `‚ö†Ô∏è Erro ao remover 'debug_test': ${error.message}\n`;
                }
                
                // 3. REMOVER COMPLETAMENTE a cole√ß√£o 'songsCache' (cache desnecess√°rio)
                try {
                    const cacheSnapshot = await db.collection('songsCache').get();
                    if (!cacheSnapshot.empty) {
                        // REMOVER TODOS OS DOCUMENTOS - n√£o precisamos mais do cache
                        const batch = db.batch();
                        cacheSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        result += `‚úÖ Cole√ß√£o 'songsCache' COMPLETAMENTE removida (${cacheSnapshot.size} documentos)\n`;
                        result += `   ‚Ä¢ Removido: a2yk9b1JXDDlogPzGO0G (575 m√∫sicas)\n`;
                        result += `   ‚Ä¢ Removido: cached_songs (115 m√∫sicas)\n`;
                        result += `   ‚Ä¢ Removido: karaoke-songs (115 m√∫sicas)\n`;
                        removedCount += cacheSnapshot.size;
                    } else {
                        result += `‚ÑπÔ∏è Cole√ß√£o 'songsCache' j√° estava vazia\n`;
                    }
                } catch (error) {
                    result += `‚ö†Ô∏è Erro ao limpar 'songsCache': ${error.message}\n`;
                }
                
                // Resultado final
                if (removedCount > 0) {
                    result += `\nüéâ LIMPEZA CONCLU√çDA!\n`;
                    result += `‚úÖ Total de documentos removidos: ${removedCount}\n`;
                    result += `üí° Sistema otimizado - apenas dados necess√°rios mantidos\n`;
                    result += `\nüìã STATUS DAS COLE√á√ïES:\n`;
                    result += `   ‚Ä¢ 'songs' - Cole√ß√£o principal (MANTIDA) ‚úÖ\n`;
                    result += `   ‚Ä¢ 'songsCache' - REMOVIDA COMPLETAMENTE ‚ùå\n`;
                    result += `   ‚Ä¢ 'searchCache' - REMOVIDA COMPLETAMENTE ‚ùå\n`;
                    result += `   ‚Ä¢ 'debug_test' - REMOVIDA COMPLETAMENTE ‚ùå\n`;
                    result += `\nüéØ RESULTADO:\n`;
                    result += `   Agora voc√™ tem apenas a cole√ß√£o 'songs' com suas 575 m√∫sicas!\n`;
                    result += `   Todas as cole√ß√µes de cache desnecess√°rias foram eliminadas!\n`;
                    showResult('cleanup-result', result, 'success');
                } else {
                    result += `\n‚úÖ Sistema j√° estava otimizado - nenhuma limpeza necess√°ria\n`;
                    showResult('cleanup-result', result, 'info');
                }
                
            } catch (error) {
                console.error('Erro na limpeza:', error);
                showResult('cleanup-result', `‚ùå Erro na limpeza: ${error.message}`, 'error');
            }
        }

        // Auto-executar verifica√ß√£o ao carregar
        window.onload = function() {
            setTimeout(listCollections, 1000);
        };
    </script>
</body>
</html>