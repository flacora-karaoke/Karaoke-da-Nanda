<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Duplicatas - Karaok√™ da Nanda</title>
    <script src="../config.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00d2d3 0%, #54a0ff 100%);
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.info { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.warning { background: #fff3e0; color: #f57c00; }
        .status.error { background: #ffebee; color: #c62828; }
        
        .results {
            margin-top: 20px;
        }
        
        .duplicate-group {
            background: #f8f9fa;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .duplicate-header {
            font-weight: bold;
            color: #c62828;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .song-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ff6b6b;
        }
        
        .song-id {
            font-family: monospace;
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .logs {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç An√°lise de Duplicatas</h1>
        
        <div class="controls">
            <button class="btn-primary" onclick="analyzeDuplicates()">üîç Analisar Duplicatas</button>
            <button class="btn-danger" onclick="removeDuplicates()" id="removeBtn" style="display:none;">üóëÔ∏è Remover Duplicatas</button>
            <button class="btn-success" onclick="clearLogs()">üßπ Limpar Logs</button>
        </div>
        
        <div id="status-container"></div>
        
        <div class="stats" id="stats" style="display:none;">
            <div class="stat-card">
                <div class="stat-number" id="totalSongs">0</div>
                <div>Total de M√∫sicas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="duplicateGroups">0</div>
                <div>Grupos Duplicados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="duplicateSongs">0</div>
                <div>M√∫sicas Duplicadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="toRemove">0</div>
                <div>Para Remover</div>
            </div>
        </div>
        
        <div class="results" id="results"></div>
        
        <div class="logs" id="logs"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // Configura√ß√£o do Firebase - usando configura√ß√µes centralizadas
        if (!window.firebaseConfig || !validateConfig(window.firebaseConfig)) {
            alert('‚ùå Configura√ß√µes do Firebase n√£o encontradas ou inv√°lidas!');
            throw new Error('Configura√ß√µes do Firebase necess√°rias n√£o encontradas');
        }

        // Inicializar Firebase
        firebase.initializeApp(window.firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let duplicateData = null;

        function addStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-container');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            statusContainer.appendChild(statusDiv);
            statusContainer.scrollTop = statusContainer.scrollHeight;
        }

        function addLog(message) {
            const logsContainer = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsContainer.appendChild(logDiv);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('status-container').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('removeBtn').style.display = 'none';
        }

        async function ensureAuth() {
            if (!auth.currentUser) {
                await auth.signInAnonymously();
            }
        }

        function normalizeString(str) {
            return str.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^\w\s]/g, '') // Remove pontua√ß√£o
                .replace(/\s+/g, ' ') // Normaliza espa√ßos
                .trim();
        }

        async function analyzeDuplicates() {
            addStatus('üîç Iniciando an√°lise de duplicatas...', 'info');
            addLog('üîç AN√ÅLISE DE DUPLICATAS INICIADA');

            try {
                await ensureAuth();
                addLog('‚úÖ Autentica√ß√£o realizada');

                // Carregar todas as m√∫sicas
                addLog('üìä Carregando m√∫sicas da cole√ß√£o songs...');
                const songsRef = db.collection('songs');
                const snapshot = await songsRef.get();

                if (snapshot.empty) {
                    addStatus('‚ö†Ô∏è Nenhuma m√∫sica encontrada na cole√ß√£o', 'warning');
                    return;
                }

                const songs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    songs.push({
                        id: doc.id,
                        title: data.title || '',
                        artist: data.artist || '',
                        genre: data.genre || 'outros',
                        videoId: data.videoId || null,
                        normalizedKey: normalizeString(`${data.title || ''} ${data.artist || ''}`)
                    });
                });

                addLog(`üìä Total de m√∫sicas carregadas: ${songs.length}`);

                // Agrupar por t√≠tulo + artista normalizado
                const groups = {};
                songs.forEach(song => {
                    if (!groups[song.normalizedKey]) {
                        groups[song.normalizedKey] = [];
                    }
                    groups[song.normalizedKey].push(song);
                });

                // Encontrar duplicatas
                const duplicates = {};
                let totalDuplicates = 0;
                let songsToRemove = 0;

                Object.keys(groups).forEach(key => {
                    if (groups[key].length > 1) {
                        duplicates[key] = groups[key];
                        totalDuplicates += groups[key].length;
                        songsToRemove += groups[key].length - 1; // Manter apenas 1 de cada grupo
                    }
                });

                // Atualizar estat√≠sticas
                document.getElementById('totalSongs').textContent = songs.length;
                document.getElementById('duplicateGroups').textContent = Object.keys(duplicates).length;
                document.getElementById('duplicateSongs').textContent = totalDuplicates;
                document.getElementById('toRemove').textContent = songsToRemove;
                document.getElementById('stats').style.display = 'grid';

                // Exibir resultados
                displayDuplicates(duplicates);

                if (Object.keys(duplicates).length > 0) {
                    addStatus(`üö® Encontradas ${Object.keys(duplicates).length} grupos de duplicatas!`, 'error');
                    addLog(`üö® DUPLICATAS ENCONTRADAS: ${Object.keys(duplicates).length} grupos`);
                    addLog(`üìä Total de m√∫sicas duplicadas: ${totalDuplicates}`);
                    addLog(`üóëÔ∏è M√∫sicas para remover: ${songsToRemove}`);
                    
                    duplicateData = duplicates;
                    document.getElementById('removeBtn').style.display = 'inline-block';
                } else {
                    addStatus('‚úÖ Nenhuma duplicata encontrada!', 'success');
                    addLog('‚úÖ AN√ÅLISE CONCLU√çDA: Nenhuma duplicata encontrada');
                }

            } catch (error) {
                addStatus(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
                addLog(`‚ùå ERRO: ${error.message}`);
                console.error('Erro:', error);
            }
        }

        function displayDuplicates(duplicates) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            if (Object.keys(duplicates).length === 0) {
                resultsContainer.innerHTML = '<div class="status success">‚úÖ Nenhuma duplicata encontrada!</div>';
                return;
            }

            Object.keys(duplicates).forEach(key => {
                const group = duplicates[key];
                const groupDiv = document.createElement('div');
                groupDiv.className = 'duplicate-group';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'duplicate-header';
                headerDiv.textContent = `üéµ "${group[0].title}" - ${group[0].artist} (${group.length} duplicatas)`;
                groupDiv.appendChild(headerDiv);

                group.forEach((song, index) => {
                    const songDiv = document.createElement('div');
                    songDiv.className = 'song-item';
                    songDiv.innerHTML = `
                        <strong>${index === 0 ? '‚úÖ MANTER' : 'üóëÔ∏è REMOVER'}:</strong> 
                        <span class="song-id">${song.id}</span> - 
                        ${song.title} - ${song.artist} 
                        ${song.videoId ? `(VideoID: ${song.videoId})` : '(Sem v√≠deo)'}
                    `;
                    groupDiv.appendChild(songDiv);
                });

                resultsContainer.appendChild(groupDiv);
            });
        }

        async function removeDuplicates() {
            if (!duplicateData) {
                addStatus('‚ùå Execute a an√°lise primeiro!', 'error');
                return;
            }

            const confirmed = confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° remover permanentemente as m√∫sicas duplicadas do Firebase!\n\nDeseja continuar?');
            if (!confirmed) {
                addLog('‚ùå Opera√ß√£o cancelada pelo usu√°rio');
                return;
            }

            addStatus('üóëÔ∏è Iniciando remo√ß√£o de duplicatas...', 'warning');
            addLog('üóëÔ∏è REMO√á√ÉO DE DUPLICATAS INICIADA');

            try {
                let removedCount = 0;
                const batch = db.batch();

                Object.keys(duplicateData).forEach(key => {
                    const group = duplicateData[key];
                    // Remover todas exceto a primeira (√≠ndice 0)
                    for (let i = 1; i < group.length; i++) {
                        const songRef = db.collection('songs').doc(group[i].id);
                        batch.delete(songRef);
                        removedCount++;
                        addLog(`üóëÔ∏è Marcando para remo√ß√£o: ${group[i].title} - ${group[i].artist} (${group[i].id})`);
                    }
                });

                addLog(`üìä Total de documentos para remover: ${removedCount}`);
                addLog('üíæ Executando remo√ß√£o em lote...');

                await batch.commit();

                addStatus(`‚úÖ Remo√ß√£o conclu√≠da! ${removedCount} duplicatas removidas.`, 'success');
                addLog(`‚úÖ REMO√á√ÉO CONCLU√çDA: ${removedCount} m√∫sicas duplicadas removidas`);
                addLog('üéâ Base de dados otimizada com sucesso!');

                // Limpar dados e interface
                duplicateData = null;
                document.getElementById('removeBtn').style.display = 'none';
                document.getElementById('results').innerHTML = '<div class="status success">‚úÖ Duplicatas removidas com sucesso!</div>';

            } catch (error) {
                addStatus(`‚ùå Erro na remo√ß√£o: ${error.message}`, 'error');
                addLog(`‚ùå ERRO NA REMO√á√ÉO: ${error.message}`);
                console.error('Erro:', error);
            }
        }

        // Auto-executar an√°lise ao carregar
        window.onload = function() {
            addLog('üé§ Analisador de Duplicatas carregado');
            addStatus('‚úÖ Sistema pronto para an√°lise', 'info');
        };
    </script>
</body>
</html>