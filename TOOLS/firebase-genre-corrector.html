<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Corretor Autom√°tico de G√™neros - Firebase</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-size: 2.5em;
        }
        .step {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #4CAF50;
        }
        .step h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        .warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }
        .info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        .progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .confidence-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        .confidence-filter input {
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .confidence-filter input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .correction-preview {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .correction-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
        }
        .correction-item.low-confidence {
            border-left-color: #ff9800;
        }
        .correction-item.very-low-confidence {
            border-left-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Corretor Autom√°tico de G√™neros</h1>
        <p style="text-align: center; font-size: 1.2em; opacity: 0.9;">
            Ferramenta para corrigir automaticamente os g√™neros das suas 578 m√∫sicas no Firebase
        </p>
    </div>

    <!-- PASSO 1: BACKUP -->
    <div class="container">
        <div class="step">
            <h3>üõ°Ô∏è PASSO 1: Backup de Seguran√ßa</h3>
            <p>Antes de fazer qualquer altera√ß√£o, vamos criar um backup completo dos dados atuais.</p>
            <button class="button info" onclick="createBackup()">Criar Backup</button>
            <div id="backupStatus"></div>
        </div>
    </div>

    <!-- PASSO 2: AN√ÅLISE -->
    <div class="container">
        <div class="step">
            <h3>üîç PASSO 2: An√°lise das M√∫sicas</h3>
            <p>Carregar todas as m√∫sicas do Firebase e analisar quais precisam de corre√ß√£o.</p>
            <button class="button" onclick="analyzeMusic()" id="analyzeBtn">Analisar M√∫sicas</button>
            
            <div class="stats" id="analysisStats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalSongs">0</div>
                    <div>Total de M√∫sicas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="needsCorrection">0</div>
                    <div>Precisam Corre√ß√£o</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="highConfidence">0</div>
                    <div>Alta Confian√ßa (‚â•85%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lowConfidence">0</div>
                    <div>Baixa Confian√ßa (<85%)</div>
                </div>
            </div>

            <div class="progress" id="analysisProgress" style="display: none;">
                <div class="progress-bar" id="analysisProgressBar"></div>
            </div>
            <div class="log" id="analysisLog" style="display: none;"></div>
        </div>
    </div>

    <!-- PASSO 3: CONFIGURA√á√ÉO -->
    <div class="container">
        <div class="step">
            <h3>‚öôÔ∏è PASSO 3: Configura√ß√£o da Corre√ß√£o</h3>
            <p>Configure os crit√©rios para corre√ß√£o autom√°tica.</p>
            
            <div class="confidence-filter">
                <label>Confian√ßa m√≠nima para corre√ß√£o autom√°tica:</label>
                <input type="number" id="minConfidence" value="85" min="0" max="100">
                <span>%</span>
            </div>
            
            <div class="confidence-filter">
                <label>
                    <input type="checkbox" id="previewMode" checked>
                    Modo Preview (n√£o aplicar altera√ß√µes, apenas mostrar)
                </label>
            </div>
            
            <button class="button warning" onclick="generateCorrectionPlan()">Gerar Plano de Corre√ß√£o</button>
        </div>
    </div>

    <!-- PASSO 4: PREVIEW -->
    <div class="container" id="previewContainer" style="display: none;">
        <div class="step">
            <h3>üëÄ PASSO 4: Preview das Corre√ß√µes</h3>
            <p>Revise as corre√ß√µes propostas antes de aplicar.</p>
            
            <div class="correction-preview" id="correctionPreview"></div>
            
            <button class="button danger" onclick="applyCorrections()" id="applyBtn">
                üöÄ Aplicar Corre√ß√µes no Firebase
            </button>
        </div>
    </div>

    <!-- PASSO 5: EXECU√á√ÉO -->
    <div class="container" id="executionContainer" style="display: none;">
        <div class="step">
            <h3>üöÄ PASSO 5: Aplicando Corre√ß√µes</h3>
            <div class="progress">
                <div class="progress-bar" id="correctionProgressBar"></div>
            </div>
            <div class="log" id="correctionLog"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="../config.js"></script>
    <script src="../genre-classifier.js"></script>
    <script>
        let musicData = [];
        let correctionPlan = [];
        let backupData = null;

        // Fun√ß√£o para monitorar cotas e limites do Firebase
        function addQuotaMonitoring() {
            const originalFirestore = firebase.firestore;
            let operationCount = 0;
            let lastResetTime = Date.now();
            const QUOTA_RESET_INTERVAL = 60000; // 1 minuto
            const MAX_OPERATIONS_PER_MINUTE = 100; // Limite conservador
            
            firebase.firestore = function() {
                const db = originalFirestore.apply(this, arguments);
                const originalCollection = db.collection;
                
                db.collection = function(path) {
                    const collection = originalCollection.apply(this, arguments);
                    const originalDoc = collection.doc;
                    
                    collection.doc = function(docId) {
                        const doc = originalDoc.apply(this, arguments);
                        const originalUpdate = doc.update;
                        
                        doc.update = function(data) {
                            // Reset contador se passou 1 minuto
                            const now = Date.now();
                            if (now - lastResetTime > QUOTA_RESET_INTERVAL) {
                                operationCount = 0;
                                lastResetTime = now;
                                console.log('üîÑ Contador de opera√ß√µes resetado');
                            }
                            
                            operationCount++;
                            console.log(`üìä Opera√ß√£o ${operationCount}/${MAX_OPERATIONS_PER_MINUTE} (√∫ltimo minuto)`);
                            
                            // Aviso se aproximando do limite
                            if (operationCount > MAX_OPERATIONS_PER_MINUTE * 0.8) {
                                console.warn('‚ö†Ô∏è Aproximando do limite de opera√ß√µes por minuto');
                            }
                            
                            // Delay se exceder limite
                            if (operationCount > MAX_OPERATIONS_PER_MINUTE) {
                                const waitTime = QUOTA_RESET_INTERVAL - (now - lastResetTime);
                                console.warn(`üö´ Limite excedido. Aguardando ${waitTime}ms...`);
                                return new Promise(resolve => {
                                    setTimeout(() => {
                                        operationCount = 1;
                                        lastResetTime = Date.now();
                                        resolve(originalUpdate.apply(this, arguments));
                                    }, waitTime);
                                });
                            }
                            
                            return originalUpdate.apply(this, arguments);
                        };
                        
                        return doc;
                    };
                    
                    return collection;
                };
                
                return db;
            };
        }
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('üéµ Corretor de G√™neros carregado');
            
            // Verificar se Firebase est√° configurado
            if (typeof firebase === 'undefined') {
                console.error('Firebase n√£o carregado!');
                alert('Erro: Firebase n√£o est√° configurado. Verifique o arquivo config.js');
                return;
            }
            
            // Inicializar Firebase
            try {
                if (typeof firebaseConfig !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    console.log('üî• Firebase inicializado com sucesso');
                    
                    // Adicionar monitoramento de cotas
                    addQuotaMonitoring();
                    console.log('üìä Sistema de monitoramento de cotas ativado');
                    
                    // Configurar Firestore
                    const db = firebase.firestore();
                    
                    // Autentica√ß√£o an√¥nima para acessar o Firestore
                    const auth = firebase.auth();
                    await auth.signInAnonymously();
                    console.log('üîê Autentica√ß√£o Firebase realizada com sucesso');
                    
                } else {
                    console.error('Configura√ß√£o do Firebase n√£o encontrada!');
                    alert('Erro: Configura√ß√£o do Firebase n√£o encontrada no config.js');
                    return;
                }
            } catch (error) {
                console.error('Erro ao inicializar Firebase:', error);
                alert('Erro ao inicializar Firebase: ' + error.message);
                return;
            }
            
            // Verificar se classificador est√° dispon√≠vel
            if (typeof classifyGenre !== 'function') {
                console.error('Classificador de g√™neros n√£o carregado!');
                alert('Erro: Sistema de classifica√ß√£o n√£o est√° dispon√≠vel. Verifique o arquivo genre-classifier.js');
                return;
            }
            
            console.log('‚úÖ Todos os sistemas carregados com sucesso');
        });

        // PASSO 1: Criar Backup
        async function createBackup() {
            const statusDiv = document.getElementById('backupStatus');
            statusDiv.innerHTML = '<p>üîÑ Criando backup...</p>';
            
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('songs').get();
                
                backupData = [];
                snapshot.forEach(doc => {
                    backupData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Salvar backup localmente
                const backupJson = JSON.stringify(backupData, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `firebase-backup-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                a.click();
                
                statusDiv.innerHTML = `
                    <p style="color: #4CAF50;">‚úÖ Backup criado com sucesso!</p>
                    <p>üìÅ ${backupData.length} m√∫sicas salvas no backup</p>
                    <p>üíæ Arquivo baixado automaticamente</p>
                `;
                
                // Habilitar pr√≥ximo passo
                document.getElementById('analyzeBtn').disabled = false;
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                statusDiv.innerHTML = `<p style="color: #f44336;">‚ùå Erro ao criar backup: ${error.message}</p>`;
            }
        }

        // PASSO 2: Analisar M√∫sicas
        async function analyzeMusic() {
            const logDiv = document.getElementById('analysisLog');
            const progressDiv = document.getElementById('analysisProgress');
            const progressBar = document.getElementById('analysisProgressBar');
            const statsDiv = document.getElementById('analysisStats');
            
            logDiv.style.display = 'block';
            progressDiv.style.display = 'block';
            statsDiv.style.display = 'grid';
            
            logDiv.innerHTML = '';
            
            function addLog(message) {
                logDiv.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${message}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            
            try {
                addLog('üîÑ Carregando m√∫sicas do Firebase...');
                
                const db = firebase.firestore();
                const snapshot = await db.collection('songs').get();
                
                musicData = [];
                snapshot.forEach(doc => {
                    musicData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                addLog(`üìä ${musicData.length} m√∫sicas carregadas`);
                
                // Analisar cada m√∫sica
                let processed = 0;
                let needsCorrection = 0;
                let highConfidence = 0;
                let lowConfidence = 0;
                
                for (const music of musicData) {
                    const result = classifyGenre(music.artist, music.title);
                    music.suggestedGenre = result.genre;
                    music.confidence = result.confidence;
                    music.method = result.method;
                    music.details = result.details;
                    
                    // Verificar se precisa corre√ß√£o
                    if (music.genre !== result.genre) {
                        needsCorrection++;
                        if (result.confidence >= 85) {
                            highConfidence++;
                        } else {
                            lowConfidence++;
                        }
                    }
                    
                    processed++;
                    const progress = (processed / musicData.length) * 100;
                    progressBar.style.width = progress + '%';
                    
                    if (processed % 50 === 0) {
                        addLog(`üìà Processadas ${processed}/${musicData.length} m√∫sicas`);
                    }
                }
                
                // Atualizar estat√≠sticas
                document.getElementById('totalSongs').textContent = musicData.length;
                document.getElementById('needsCorrection').textContent = needsCorrection;
                document.getElementById('highConfidence').textContent = highConfidence;
                document.getElementById('lowConfidence').textContent = lowConfidence;
                
                addLog(`‚úÖ An√°lise conclu√≠da!`);
                addLog(`üìä ${needsCorrection} m√∫sicas precisam de corre√ß√£o`);
                addLog(`üéØ ${highConfidence} com alta confian√ßa (‚â•85%)`);
                addLog(`‚ö†Ô∏è ${lowConfidence} com baixa confian√ßa (<85%)`);
                
            } catch (error) {
                console.error('Erro na an√°lise:', error);
                addLog(`‚ùå Erro na an√°lise: ${error.message}`);
            }
        }

        // PASSO 3: Gerar Plano de Corre√ß√£o
        function generateCorrectionPlan() {
            const minConfidence = parseInt(document.getElementById('minConfidence').value);
            const previewContainer = document.getElementById('previewContainer');
            const previewDiv = document.getElementById('correctionPreview');
            
            correctionPlan = musicData.filter(music => {
                return music.genre !== music.suggestedGenre && music.confidence >= minConfidence;
            });
            
            let html = `<h4>üìã Plano de Corre√ß√£o (${correctionPlan.length} m√∫sicas)</h4>`;
            
            correctionPlan.forEach((music, index) => {
                const confidenceClass = music.confidence >= 85 ? '' : 
                                      music.confidence >= 60 ? 'low-confidence' : 'very-low-confidence';
                
                html += `
                    <div class="correction-item ${confidenceClass}">
                        <strong>${music.title} - ${music.artist}</strong><br>
                        <span style="color: #f44336;">Atual: ${music.genre}</span> ‚Üí 
                        <span style="color: #4CAF50;">Novo: ${music.suggestedGenre}</span><br>
                        <small>Confian√ßa: ${music.confidence}% | M√©todo: ${music.method}</small>
                    </div>
                `;
            });
            
            previewDiv.innerHTML = html;
            previewContainer.style.display = 'block';
        }

        // PASSO 4: Aplicar Corre√ß√µes com tratamento robusto de erros
        async function applyCorrections() {
            const previewMode = document.getElementById('previewMode').checked;
            const executionContainer = document.getElementById('executionContainer');
            const progressBar = document.getElementById('correctionProgressBar');
            const logDiv = document.getElementById('correctionLog');
            
            if (previewMode) {
                alert('‚ö†Ô∏è Modo Preview ativado. Desmarque a op√ß√£o para aplicar as corre√ß√µes realmente.');
                return;
            }
            
            if (!correctionPlan || correctionPlan.length === 0) {
                alert('‚ùå Nenhuma corre√ß√£o para aplicar. Execute a an√°lise primeiro.');
                return;
            }
            
            if (!confirm(`üö® ATEN√á√ÉO! Voc√™ est√° prestes a alterar ${correctionPlan.length} m√∫sicas no Firebase. Tem certeza?`)) {
                return;
            }
            
            executionContainer.style.display = 'block';
            logDiv.innerHTML = '';
            
            function addLog(message) {
                logDiv.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${message}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            
            const batchSize = 10; // Processar em lotes menores
            const maxRetries = 3;
            
            // Fun√ß√£o para delay entre opera√ß√µes
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            // Fun√ß√£o para retry com backoff exponencial
            const retryWithBackoff = async (operation, retries = maxRetries) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        return await operation();
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        
                        const backoffTime = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                        addLog(`‚è≥ Tentativa ${i + 1} falhou, aguardando ${backoffTime}ms...`);
                        await delay(backoffTime);
                    }
                }
            };
            
            try {
                const db = firebase.firestore();
                let processed = 0;
                let successful = 0;
                let failed = 0;
                
                addLog(`üöÄ Iniciando corre√ß√£o de ${correctionPlan.length} m√∫sicas...`);
                
                // Processar em lotes
                for (let i = 0; i < correctionPlan.length; i += batchSize) {
                    const batch = correctionPlan.slice(i, i + batchSize);
                    
                    addLog(`üì¶ Processando lote ${Math.floor(i/batchSize) + 1}/${Math.ceil(correctionPlan.length/batchSize)}`);
                    
                    // Processar cada item do lote
                    for (const music of batch) {
                        try {
                            await retryWithBackoff(async () => {
                                await db.collection('songs').doc(music.id).update({
                                    genre: music.suggestedGenre
                                });
                            });
                            
                            successful++;
                            addLog(`‚úÖ ${music.title} - ${music.artist}: ${music.genre} ‚Üí ${music.suggestedGenre}`);
                            
                        } catch (error) {
                            failed++;
                            addLog(`‚ùå Erro em ${music.title}: ${error.message}`);
                        }
                        
                        processed++;
                        const progress = (processed / correctionPlan.length) * 100;
                        progressBar.style.width = progress + '%';
                    }
                    
                    // Delay entre lotes para n√£o sobrecarregar o Firebase
                    if (i + batchSize < correctionPlan.length) {
                        await delay(500);
                    }
                }
                
                addLog(`üéâ Corre√ß√£o conclu√≠da!`);
                addLog(`‚úÖ ${successful} m√∫sicas corrigidas com sucesso`);
                addLog(`‚ùå ${failed} falhas`);
                
                alert(`üéâ Corre√ß√£o conclu√≠da!\n‚úÖ ${successful} sucessos\n‚ùå ${failed} falhas`);
                
            } catch (error) {
                console.error('Erro na corre√ß√£o:', error);
                addLog(`‚ùå Erro geral: ${error.message}`);
            }
        }
    </script>
</body>
</html>